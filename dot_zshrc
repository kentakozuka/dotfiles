# Amazon Q pre block. Keep at the top of this file.
[[ -f "${HOME}/Library/Application Support/amazon-q/shell/zshrc.pre.zsh" ]] && builtin source "${HOME}/Library/Application Support/amazon-q/shell/zshrc.pre.zsh"

# Plugins"
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"
plugins=(git zsh-autosuggestions zsh-syntax-highlighting fast-syntax-highlighting)
source $ZSH/oh-my-zsh.sh

# Custom functions
function gctx() {
	local select=$(gcloud config configurations list --format='[no-heading]' | awk '{ print $1,$2,$3,$4 }' | column -t | peco | awk '{ print $1 }')
	print -z gcloud config configurations activate ${select}
}
function actx() {
	local select=$(aws configure list-profiles | peco | awk '{ print $1 }')
	print -z export AWS_PROFILE=${select}
}
# ^g: pick branch with inc search
function pick-git-branch {
    local picked=$(git branch | peco | tr -d ' ')
    BUFFER="${BUFFER}${picked}"
    CURSOR=$#BUFFER
    zle redisplay
}
zle -N pick-git-branch
bindkey '^g' pick-git-branch

# ^i: pick branch with inc search
function pick-isengard-account {
    local picked=$(isengardcli ls --output emails | grep 'kentako' | peco | tr -d ' ')
    BUFFER="${BUFFER}${picked}"
    CURSOR=$#BUFFER
    zle redisplay
}
zle -N pick-isengard-account
bindkey '^r' pick-isengard-account

function hs() {
	print -z `history -n 1 | tac | peco`
	CURSOR=$#BUFFER
}
# history size
HISTSIZE=100000
SAVEHIST=100000
# do not keep duplicated histories
setopt hist_ignore_dups
# delete an old history when duplicated
setopt hist_ignore_all_dups
# write beginning and end time
setopt EXTENDED_HISTORY
# delete spaces that is not necesary
setopt hist_reduce_blanks
# history command is not stored
setopt hist_no_store
# share history between shells
setopt share_history
# write history incrementaly
setopt inc_append_history
# search incrementaly
autoload -U history-search-end
zle -N history-beginning-search-backward-end history-search-end
zle -N history-beginning-search-forward-end history-search-end
bindkey "^p" history-beginning-search-backward-end
bindkey "^n" history-beginning-search-forward-end
# emacs mode
bindkey -e
# vim as a default editor
export EDITOR="vim"

alias g='git'
alias gc='git commit -s -m'
alias gco='git checkout'
alias ghpr='gh pr view --web'
alias ghrp='gh repo view --web'
alias gt='cd "$(git rev-parse --show-toplevel)"'
alias reload='exec -l $SHELL;source ~/.zshrc'
alias vim='nvim'
alias ls='eza --icons --git'
alias l='eza --icons --git'
alias ll='eza --icons --git --sort time -la'
alias cm='chezmoi'
alias '?'='q chat --no-interactive'


[[ ! -d "$HOME/.asdf" ]] && git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.16.7
export PATH="${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
[[ ! -d "$HOME/.asdf/plugins/peco" ]] && asdf plugin add peco && asdf install peco latest && asdf set -u peco latest
[[ ! -d "$HOME/.asdf/plugins/ghq" ]] && asdf plugin add ghq && asdf install ghq latest && asdf set -u ghq latest
[[ ! -d "$HOME/.asdf/plugins/golang" ]] && . ~/.asdf/plugins/golang/set-env.zsh
export PATH=$PATH:$(go env GOPATH)/bin

[[ ! -d "$HOME/.asdf/plugins/gcloud" ]] && asdf plugin add gcloud && asdf install gcloud latest && asdf set -u gcloud latest
curr=$(asdf current gcloud | awk '{print $2}')
# source $HOME/.asdf/installs/gcloud/${curr}/completion.zsh.inc
# source $HOME/.asdf/installs/gcloud/${curr}/path.zsh.inc

if [ "$(uname)" = "Darwin" ] ; then
	defaults write com.apple.dock mru-spaces -bool false && killall Dock 2>/dev/null || true
	defaults write com.apple.dock autohide -bool true && killall Dock 2>/dev/null || true
	defaults write NSGlobalDomain AppleICUForce24HourTime -bool true && killall Dock 2>/dev/null || true
	defaults write NSGlobalDomain _HIHideMenuBar -bool false && killall Dock 2>/dev/null || true
	# https://github.com/VSCodeVim/Vim#mac-setup
	defaults write com.microsoft.VSCode ApplePressAndHoldEnabled -bool false
	defaults write com.microsoft.VSCodeInsiders ApplePressAndHoldEnabled -bool false
	defaults write com.vscodium ApplePressAndHoldEnabled -bool false
	defaults write com.microsoft.VSCodeExploration ApplePressAndHoldEnabled -bool false
	# Only delete if the preference exists
	defaults read -g ApplePressAndHoldEnabled &>/dev/null && defaults delete -g ApplePressAndHoldEnabled
	# 1Password SSH Agent
	# export SSH_AUTH_SOCK=~/Library/Group\ Containers/2BUA8C4S2C.com.1password/t/agent.sock
	# . $HOME/.config/op/plugins.sh
	# eval "$(/opt/homebrew/bin/brew shellenv)"
fi

export PATH=$PATH:$HOME/.toolbox/bin

# https://github.com/cline/cline/wiki/Troubleshooting-%E2%80%90-Shell-Integration-Unavailable#still-having-trouble
[[ "$TERM_PROGRAM" == "vscode" ]] && builtin source "$(code --locate-shell-integration-path zsh)"

export PATH="$PATH:$(go env GOBIN)"

[[ -f "${HOME}/.local/share/chezmoi/private/.zshrc" ]] && builtin source "${HOME}/.local/share/chezmoi/private/.zshrc"

# Amazon Q post block. Keep at the bottom of this file.
[[ -f "${HOME}/Library/Application Support/amazon-q/shell/zshrc.post.zsh" ]] && builtin source "${HOME}/Library/Application Support/amazon-q/shell/zshrc.post.zsh"
alias agentcore-jp="LANG=ja_JP.UTF-8 LC_ALL=ja_JP.UTF-8 agentcore"
